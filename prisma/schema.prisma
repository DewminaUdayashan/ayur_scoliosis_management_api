// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AppUser {
  id                         String         @id @default(uuid())
  firstName                  String
  lastName                   String
  email                      String         @unique
  phone                      String?
  passwordHash               String
  role                       UserRole
  profileImageUrl            String?
  mustChangePassword         Boolean        @default(false)
  joinedDate                 DateTime       @default(now()) 
  practitioner               Practitioner?
  patient                    Patient?
  appointmentsAsPatient      Appointment[]  @relation("PatientAppointments")
  appointmentsAsPractitioner Appointment[]  @relation("PractitionerAppointments")
  notifications              Notification[] @relation("UserNotifications")
  eventsAsPatient            PatientEvent[] @relation("EventsForPatient")
  eventsCreatedBy            PatientEvent[] @relation("EventsCreatedByPractitioner")
  measurementsCreated        XRayMeasurement[] @relation("MeasurementCreatedBy")
}

model Practitioner {
  appUser        AppUser @relation(fields: [appUserId], references: [id])
  appUserId      String  @id @unique
  specialty      String
  medicalLicense String
  status         AccountStatus
  clinic         Clinic  @relation(fields: [clinicId], references: [id])
  clinicId       String
  invitedPatients Patient[]
}

model Patient {
  appUser         AppUser  @relation(fields: [appUserId], references: [id])
  appUserId       String   @id @unique
  profileImageUrl String?
  dateOfBirth     DateTime
  gender          String
  practitioner   Practitioner @relation(fields: [practitionerId], references: [appUserId])
  practitionerId String
}

model Clinic {
  id            String         @id @default(uuid())
  name          String
  addressLine1  String
  addressLine2  String?
  city          String
  email         String
  phone         String
  imageUrl      String?
  practitioners Practitioner[]
}

model Appointment {
  id                  String            @id @default(uuid())
  name                String            @default("")
  patient             AppUser           @relation("PatientAppointments", fields: [patientId], references: [id])
  patientId           String
  practitioner        AppUser           @relation("PractitionerAppointments", fields: [practitionerId], references: [id])
  practitionerId      String
  appointmentDateTime DateTime
  durationInMinutes   Int
  type                AppointmentType
  status              AppointmentStatus
  notes               String?
  videoCallRoom       VideoCallRoom?
  patientEvent        PatientEvent[]
}

model Notification {
  id             String        @id @default(uuid())
  recipient      AppUser       @relation("UserNotifications", fields: [recipientId], references: [id])
  recipientId    String
  title          String
  message        String
  isRead         Boolean       @default(false)
  createdAt      DateTime      @default(now())
  relatedEvent   PatientEvent? @relation(fields: [relatedEventId], references: [id])
  relatedEventId String?       @unique
}

model PatientEvent {
  id                      String                   @id @default(uuid())
  patient                 AppUser                  @relation("EventsForPatient", fields: [patientId], references: [id])
  patientId               String
  createdByPractitioner   AppUser                  @relation("EventsCreatedByPractitioner", fields: [createdByPractitionerId], references: [id])
  createdByPractitionerId String
  eventType               EventType
  eventDateTime           DateTime
  isSharedWithPatient     Boolean
  appointment             Appointment?             @relation(fields: [appointmentId], references: [id])
  appointmentId           String?                  @unique
  xrayImages              XRayImage[]
  aiClassificationResult  AIClassificationResult?
  scoliosisMeasurement    ScoliosisMeasurement?
  sessionNote             SessionNote?
  notification            Notification?
}

model XRayImage {
  id             String              @id @default(uuid())
  patientEvent   PatientEvent        @relation(fields: [patientEventId], references: [id])
  patientEventId String
  imageUrl       String
  notes          String?
  measurements   XRayMeasurement[]
}

model XRayMeasurement {
  id            String      @id @default(uuid())
  xrayImage     XRayImage   @relation(fields: [xrayImageId], references: [id], onDelete: Cascade)
  xrayImageId   String
  line1StartX   Decimal
  line1StartY   Decimal
  line1EndX     Decimal
  line1EndY     Decimal
  line2StartX   Decimal
  line2StartY   Decimal
  line2EndX     Decimal
  line2EndY     Decimal
  cobbAngle     Decimal
  createdBy     AppUser     @relation("MeasurementCreatedBy", fields: [createdById], references: [id])
  createdById   String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  notes         String?
}

model AIClassificationResult {
  id                   String                 @id @default(uuid())
  patientEvent         PatientEvent           @relation(fields: [patientEventId], references: [id])
  patientEventId       String                 @unique
  classificationResult AIClassificationType
  confidenceScore      Decimal
  notes                String?
}

model ScoliosisMeasurement {
  id             String       @id @default(uuid())
  patientEvent   PatientEvent @relation(fields: [patientEventId], references: [id])
  patientEventId String       @unique
  cobbAngle      Decimal
  rotationAngle  Decimal
  notes          String?
}

model SessionNote {
  id             String       @id @default(uuid())
  patientEvent   PatientEvent @relation(fields: [patientEventId], references: [id])
  patientEventId String       @unique
  noteContent    String
}

model PasswordReset {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime

  @@index([email, token])
}

model RevokedToken {
  id        String   @id @default(uuid())
  jti       String   @unique // The unique identifier of the JWT
  expiresAt DateTime // When the token naturally expires
}

model VideoCallRoom {
  id                  String              @id @default(uuid())
  appointment         Appointment         @relation(fields: [appointmentId], references: [id])
  appointmentId       String              @unique
  roomId              String              @unique
  status              VideoCallStatus     @default(Waiting)
  practitionerJoined  Boolean             @default(false)
  patientJoined       Boolean             @default(false)
  startedAt           DateTime?
  endedAt             DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}


enum UserRole {
  Patient
  Practitioner
  Admin
}

enum AppointmentType {
  Physical
  Remote
}

enum AppointmentStatus {
  Scheduled
  Completed
  Cancelled
  NoShow
  PendingPatientConfirmation
}

enum AccountStatus {
  Pending
  Active
  Inactive
  Suspended
}

enum EventType {
  AppointmentCompleted
  XRayUpload
  AIClassification
  CobbAngleMeasurement
  SessionNote
}

enum VideoCallStatus {
  Waiting
  InProgress
  Ended
}

enum AIClassificationType {
  NoScoliosisDetected
  ScoliosisCCurve
  ScoliosisSCurve
  NotASpinalXray
  NoXrayDetected
  AnalysisFailed
}
